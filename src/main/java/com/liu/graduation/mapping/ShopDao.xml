<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.liu.graduation.dao.ShopDao">
	<resultMap id="BaseResultMap" type="com.liu.graduation.entities.Cart" >

	    <id column="phonenum" property="phonenum" jdbcType="VARCHAR" />
	    <id column="product_id" property="product_id" jdbcType="VARCHAR" />
	    <result column="product_name" property="product_name" jdbcType="VARCHAR" />	    
	    <result column="num" property="num" jdbcType="INTEGER" />
	    <result column="stock" property="stock" jdbcType="INTEGER" />
	    <result column="picture" property="picture" jdbcType="VARCHAR" />
	    <result column="price" property="price" jdbcType="FLOAT" />
	    <result column="Unit" property="Unit" jdbcType="FLOAT" />
	    <result column="status" property="status" jdbcType="VARCHAR" />    
  	</resultMap>
  	
    <insert id="insertCart" parameterType="com.liu.graduation.entities.Cart">
    insert into shopcart
     <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="phonenum != null" >phonenum,</if>
      <if test="product_id != null" >product_id,</if>
      <if test="product_name != null" >product_name,</if>
      <if test="num != null" >num,</if>
      <if test="stock != null" >stock,</if>
      <if test="picture != null" >picture,</if>
      <if test="price != null" >price,</if>
      <if test="Unit != null" >Unit,</if>
      <if test="status != null" >status,</if>
      <if test="addtime != null" >addtime,</if>
      <if test="endtime != null" >endtime,</if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="phonenum != null" >
        #{phonenum,jdbcType=VARCHAR},
      </if>
      <if test="product_id != null" >
        #{product_id,jdbcType=VARCHAR},
      </if>
      <if test="product_name != null" >
        #{product_name,jdbcType=VARCHAR},
      </if>
      <if test="num != null" >
        #{num,jdbcType=INTEGER},
      </if>
       <if test="stock != null" >
      	#{stock,jdbcType=INTEGER},
      </if>
      <if test="picture != null" >
      	#{picture,jdbcType=VARCHAR},
      </if>
      <if test="price != null" >
      	#{price,jdbcType=FLOAT},
      </if>
      <if test="Unit != null" >
      	#{Unit,jdbcType=FLOAT},
      </if>
      <if test="status != null" >
      #{status,jdbcType=VARCHAR},
      </if>
        <if test="addtime != null" >
      #{addtime,jdbcType=TIMESTAMP},
      </if>    
      <if test="endtime != null" >
      #{endtime,jdbcType=TIMESTAMP},
      </if>
    </trim>
     on duplicate key update
    num=if(num+#{num,jdbcType=INTEGER}>stock,stock,num+#{num,jdbcType=INTEGER}),
    price=if(num=stock,stock*unit,price+#{price,jdbcType=FLOAT}*unit),
    endtime=null
  </insert>
  <select id="findCartByUser" resultMap="BaseResultMap" parameterType="java.lang.String">
        select * from shopcart
        where phonenum=#{user}
        AND endtime is null 
        order by addtime desc
   </select>
   <update id="deleteCart" parameterType="com.liu.graduation.entities.Cart">
   		UPDATE shopcart
		SET endtime=#{endtime,jdbcType=TIMESTAMP}
		WHERE phonenum= #{phonenum,jdbcType=VARCHAR} and product_id= #{product_id,jdbcType=VARCHAR}
   </update>
</mapper>
